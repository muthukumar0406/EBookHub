<div class="reader-container" *ngIf="safeUrl">
    <div class="reader-header">
        <div class="header-left">
            <button [routerLink]="['/library']" class="back-btn">
                <span class="icon">â†</span>
                <span>Library</span>
            </button>
        </div>
        <div class="header-center">
            <h3>{{ book?.title }}</h3>
        </div>
        <div class="header-right">
            <div class="zoom-controls">
                <button (click)="zoomOut()" class="zoom-btn" title="Zoom Out">A-</button>
                <span class="zoom-label">{{ (zoomLevel * 100) | number:'1.0-0' }}%</span>
                <button (click)="zoomIn()" class="zoom-btn" title="Zoom In">A+</button>
            </div>
            <span class="file-badge">{{ fileType }}</span>
        </div>
    </div>

    <div class="viewer-wrapper">
        <div class="iframe-container">
            <iframe [src]="safeUrl" width="100%" height="100%" frameborder="0" allowfullscreen
                (load)="onIframeLoad($event)">
            </iframe>

            <!-- Sketch Canvas Overlay -->
            <canvas #sketchCanvas class="sketch-layer" [class.active]="isSketchMode" (mousedown)="startDrawing($event)"
                (mousemove)="draw($event)" (mouseup)="stopDrawing()" (mouseleave)="stopDrawing()"
                (touchstart)="handleTouch($event)" (touchmove)="handleTouch($event)" (touchend)="stopDrawing()">
            </canvas>

            <!-- Floating Actions - Bottom Left -->
            <div class="floating-actions left">
                <button (click)="markAsFinished()" class="action-btn marker"
                    title="Mark current page as end of reading">
                    <span class="icon">ğŸ“</span>
                    <span class="label">Mark Page</span>
                </button>

                <!-- PDF Page Controls (Since we can't detect scroll in PDF iframe) -->
                <div class="pdf-controls glass" *ngIf="!isHtml && fileType === 'PDF'">
                    <button (click)="scrollToPage(currentPage - 1)" [disabled]="currentPage <= 1"
                        class="page-nav">â—€</button>
                    <span class="page-num">Page {{ currentPage }}</span>
                    <button (click)="scrollToPage(currentPage + 1)" class="page-nav">â–¶</button>
                </div>
            </div>
        </div>

        <!-- Floating Actions - Bottom Right -->
        <div class="floating-actions right">
            <!-- Sketch Toolbar (only visible when active) -->
            <div class="sketch-toolbar glass" *ngIf="isSketchMode">
                <button (click)="setTool('pen')" [class.active]="currentTool === 'pen'" title="Pen">ğŸ–Šï¸</button>
                <button (click)="setTool('eraser')" [class.active]="currentTool === 'eraser'" title="Eraser">ğŸ§½</button>
                <button (click)="clearCanvas()" title="Clear All">ğŸ—‘ï¸</button>
                <button (click)="saveSketch()" class="btn-save" title="Save Sketch">ğŸ’¾ Save</button>
            </div>

            <button (click)="toggleSketchMode()" class="action-btn pencil" [class.active]="isSketchMode"
                title="Sketch Tool">
                <span class="icon">{{ isSketchMode ? 'âœ–' : 'âœï¸' }}</span>
                <span class="label" *ngIf="!isSketchMode">Sketch</span>
            </button>
        </div>
    </div>

    <!-- Resume Prompt Overlay -->
    <div class="resume-overlay glass" *ngIf="showResumePrompt">
        <div class="resume-card">
            <div class="resume-icon">ğŸ“–</div>
            <div class="resume-content">
                <h4>Pick up where you left off?</h4>
                <p>You were last on <strong>Page {{ lastSavedPage }}</strong></p>
            </div>
            <div class="resume-actions">
                <button (click)="resumeReading()" class="btn-resume">Continue Reading</button>
                <button (click)="dismissResume()" class="btn-dismiss">Start from Beginning</button>
            </div>
        </div>
    </div>

    <div class="reader-footer" *ngIf="isHtml && totalPages > 0">
        <div class="page-indicator">
            Page <span>{{ currentPage }}</span> of <span>{{ totalPages }}</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="(currentPage / totalPages) * 100"></div>
        </div>
    </div>
</div>
</div>

<div *ngIf="isLoading && !errorMessage" class="loading-state">
    <div class="spinner"></div>
    <h3>Opening Book</h3>
    <p>Please wait while we prepare your reader...</p>
</div>

<div *ngIf="errorMessage" class="error-state">
    <div class="error-card glass">
        <span class="error-icon">âš ï¸</span>
        <h2>Reader Error</h2>
        <p>{{ errorMessage }}</p>
        <div class="error-actions">
            <button (click)="ngOnInit()" class="btn-primary">Try Again</button>
            <button [routerLink]="['/library']" class="btn-secondary">Back to Library</button>
        </div>
    </div>
</div>